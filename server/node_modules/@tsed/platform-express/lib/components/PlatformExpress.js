"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PlatformExpress = void 0;
const common_1 = require("@tsed/common");
const services_1 = require("../services");
/**
 * @platform
 * @express
 */
class PlatformExpress extends common_1.PlatformBuilder {
    static async bootstrap(module, settings = {}) {
        return this.build(PlatformExpress).bootstrap(module, settings);
    }
    async loadRoutes(routes) {
        this.configureViewsEngine();
        await super.loadRoutes(routes);
        // NOT FOUND
        this.app.use((req, res) => {
            var _a;
            (_a = this.injector.get(common_1.PlatformExceptions)) === null || _a === void 0 ? void 0 : _a.resourceNotFound(req.$ctx);
        });
        // EXCEPTION FILTERS
        this.app.use((err, req, res, next) => {
            var _a;
            (_a = this.injector.get(common_1.PlatformExceptions)) === null || _a === void 0 ? void 0 : _a.catch(err, req.$ctx);
        });
    }
    configureViewsEngine() {
        const platformViews = this.injector.get(common_1.PlatformViews);
        platformViews.getEngines().forEach(({ extension, engine }) => {
            this.app.getApp().engine(extension, engine);
        });
        platformViews.viewEngine && this.app.getApp().set("view engine", platformViews.viewEngine);
        platformViews.root && this.app.getApp().set("views", platformViews.root);
    }
}
exports.PlatformExpress = PlatformExpress;
PlatformExpress.providers = [
    {
        provide: common_1.PlatformApplication,
        useClass: services_1.PlatformExpressApplication
    },
    {
        provide: common_1.PlatformRouter,
        useClass: services_1.PlatformExpressRouter
    },
    {
        provide: common_1.PlatformHandler,
        useClass: services_1.PlatformExpressHandler
    },
    {
        provide: common_1.PlatformResponse,
        useClass: services_1.PlatformExpressResponse
    },
    {
        provide: common_1.PlatformRequest,
        useClass: services_1.PlatformExpressRequest
    }
];
//# sourceMappingURL=PlatformExpress.js.map