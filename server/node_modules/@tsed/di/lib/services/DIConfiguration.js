"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DIConfiguration = void 0;
const core_1 = require("@tsed/core");
class DIConfiguration {
    constructor(initialProps = {}) {
        this.default = new Map();
        this.map = new Map();
        Object.entries({
            scopes: {},
            resolvers: [],
            imports: [],
            ...initialProps
        }).forEach(([key, value]) => {
            this.default.set(key, value);
        });
        return core_1.proxyDelegation(this, {
            ownKeys(target) {
                return [...target.default.keys(), ...target.map.keys()];
            }
        });
    }
    get scopes() {
        return this.getRaw("scopes");
    }
    set scopes(value) {
        this.setRaw("scopes", value);
    }
    get resolvers() {
        return this.getRaw("resolvers");
    }
    set resolvers(resolvers) {
        this.setRaw("resolvers", resolvers);
    }
    get imports() {
        return this.getRaw("imports");
    }
    set imports(imports) {
        this.setRaw("imports", imports);
    }
    /**
     *
     * @param callbackfn
     * @param thisArg
     */
    forEach(callbackfn, thisArg) {
        return new Set([...Array.from(this.default.keys()), ...Array.from(this.map.keys())]).forEach((key) => {
            callbackfn(this.getRaw(key), key, this.map);
        }, thisArg);
    }
    /**
     *
     * @param propertyKey
     * @param value
     */
    set(propertyKey, value) {
        if (typeof propertyKey === "string") {
            this.setRaw(propertyKey, value);
        }
        else {
            Object.entries(propertyKey).forEach(([key, value]) => {
                this[key] = value;
            });
        }
        return this;
    }
    setRaw(propertyKey, value) {
        core_1.setValue(this.map, propertyKey, value);
        return this;
    }
    /**
     *
     * @param propertyKey
     * @param defaultValue
     * @returns {undefined|any}
     */
    get(propertyKey, defaultValue) {
        return this.resolve(this.getRaw(propertyKey, defaultValue));
    }
    getRaw(propertyKey, defaultValue) {
        const value = core_1.getValue(this.map, propertyKey);
        if (value !== undefined) {
            return value;
        }
        return core_1.getValue(this.default, propertyKey, defaultValue);
    }
    merge(obj) {
        Object.entries(obj).forEach(([key, value]) => {
            const descriptor = Object.getOwnPropertyDescriptor(DIConfiguration.prototype, key);
            const originalValue = this.get(key);
            value = core_1.deepExtends(value, originalValue);
            if (descriptor && !["default", "set", "map", "get"].includes(key)) {
                this[key] = value;
            }
        });
    }
    /**
     *
     * @param value
     * @returns {any}
     */
    resolve(value) {
        if (typeof value === "object" && value !== null) {
            if (![Array, Object].includes(core_1.classOf(value))) {
                return value;
            }
            return Object.entries(value).reduce((o, [k, v]) => {
                // @ts-ignore
                o[k] = this.resolve(v);
                return o;
            }, Array.isArray(value) ? [] : {});
        }
        if (typeof value === "string") {
            const replacer = (match, key) => core_1.getValue(this.map, key);
            return value
                .replace(/\${([\w.]+)}/gi, replacer)
                .replace(/<([\w.]+)>/gi, replacer)
                .replace(/{{([\w.]+)}}/gi, replacer);
        }
        return value;
    }
    build() {
        this.forEach((value, key) => this.map.set(key, this.resolve(value)));
        this.set = this.setRaw;
        this.get = this.getRaw = (propertyKey, defaultValue) => core_1.getValue(this.map, propertyKey, defaultValue);
    }
}
exports.DIConfiguration = DIConfiguration;
//# sourceMappingURL=DIConfiguration.js.map