{"version":3,"file":"HandlerContext.js","sourceRoot":"","sources":["../../../src/platform/domain/HandlerContext.ts"],"names":[],"mappings":"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","sourcesContent":["import {isObservable, isPromise, isStream} from \"@tsed/core\";\nimport {InjectorService} from \"@tsed/di\";\nimport {HandlerMetadata} from \"../../mvc/models/HandlerMetadata\";\nimport {PlatformContext} from \"./PlatformContext\";\n\n/**\n * @ignore\n */\nfunction isResponse(obj: any) {\n  return obj.data && obj.headers && obj.status && obj.statusText;\n}\n\n/**\n * @ignore\n */\nexport interface HandlerContextOptions {\n  $ctx: PlatformContext;\n  metadata: HandlerMetadata;\n  args: any[];\n  err?: any;\n}\n\n/**\n * @ignore\n */\nexport enum HandlerContextStatus {\n  PENDING = \"pending\",\n  CANCELED = \"canceled\",\n  RESOLVED = \"resolved\",\n  REJECTED = \"rejected\"\n}\n\nexport class HandlerContext {\n  public status = HandlerContextStatus.PENDING;\n  public metadata: HandlerMetadata;\n  public $ctx: PlatformContext;\n  public err: any;\n  public args: any[];\n  private resolves: any;\n  private rejects: any;\n  private promise: Promise<any>;\n\n  constructor({$ctx, err, metadata, args}: HandlerContextOptions) {\n    this.promise = new Promise((resolve: any, reject: any) => {\n      this.resolves = resolve;\n      this.rejects = reject;\n    });\n\n    this.$ctx = $ctx;\n\n    err && (this.err = err);\n    metadata && (this.metadata = metadata);\n    args && (this.args = args || []);\n\n    this.next = this.next.bind(this);\n  }\n\n  get injector(): InjectorService {\n    return this.$ctx?.injector;\n  }\n\n  get container() {\n    return this.$ctx?.container;\n  }\n\n  get request() {\n    return this.$ctx?.getRequest<TsED.Request>();\n  }\n\n  get response() {\n    return this.$ctx?.getResponse<TsED.Response>();\n  }\n\n  get isDone(): boolean {\n    const {$ctx} = this;\n    if (!$ctx || $ctx.isDone()) {\n      return true;\n    }\n\n    if ($ctx.request.isAborted() || $ctx.response.isDone()) {\n      this.destroy();\n\n      if (this.status === HandlerContextStatus.PENDING) {\n        this.status = HandlerContextStatus.RESOLVED;\n      }\n    }\n\n    return this.status !== HandlerContextStatus.PENDING;\n  }\n\n  /**\n   * Return the original request instance.\n   */\n  getRequest<T = any>(): T {\n    return this.$ctx?.request?.raw as any;\n  }\n\n  /**\n   * Return the original response instance.\n   */\n  getResponse<T = any>(): T {\n    return this.$ctx?.response?.raw as any;\n  }\n\n  /**\n   *\n   */\n  async callHandler() {\n    if (this.isDone) {\n      return this;\n    }\n\n    const {token, propertyKey} = this.metadata;\n\n    const instance: any = this.injector.invoke(token, this.container);\n    const handler = instance[propertyKey!].bind(instance);\n\n    try {\n      this.handle(handler(...this.args));\n    } catch (er) {\n      this.reject(er);\n    }\n\n    return this.promise;\n  }\n\n  reject(er: any) {\n    if (this.isDone) {\n      return;\n    }\n\n    this.destroy();\n    this.status = HandlerContextStatus.REJECTED;\n    this.rejects(er);\n  }\n\n  resolve(data?: any) {\n    if (this.isDone) {\n      return;\n    }\n\n    if (this.$ctx && data !== undefined) {\n      this.$ctx.data = data;\n    }\n\n    this.destroy();\n    this.status = HandlerContextStatus.RESOLVED;\n\n    this.resolves(data);\n  }\n\n  next(error?: any) {\n    if (this.isDone) {\n      return;\n    }\n\n    return error ? this.reject(error) : this.resolve();\n  }\n\n  destroy() {\n    // @ts-ignore\n    delete this.$ctx;\n    // @ts-ignore\n    delete this.args;\n    // @ts-ignore\n    delete this.metadata;\n    // @ts-ignore\n    delete this.err;\n  }\n\n  cancel() {\n    if (this.isDone) {\n      return;\n    }\n\n    this.destroy();\n    this.status = HandlerContextStatus.CANCELED;\n\n    return this.resolves();\n  }\n\n  handle(process: any): any {\n    if (this.isDone) {\n      return;\n    }\n\n    const {\n      metadata: {hasNextFunction},\n      $ctx\n    } = this;\n\n    if (process) {\n      if (process === $ctx.getResponse()) {\n        // ABANDON\n        return this.cancel();\n      }\n\n      if (isObservable(process)) {\n        process = process.toPromise();\n      }\n\n      if (isResponse(process)) {\n        $ctx.response.setHeaders(process.headers);\n        $ctx.response.status(process.status);\n\n        return this.handle(process.data);\n      }\n\n      if (isStream(process) || Buffer.isBuffer(process)) {\n        return this.resolve(process);\n      }\n\n      if (isPromise(process)) {\n        return process.then((result: any) => this.handle(result)).catch((error: unknown) => this.reject(error));\n      }\n    }\n\n    if (!hasNextFunction) {\n      // no next function and empty response\n      return this.resolve(process);\n    }\n  }\n}\n"]}