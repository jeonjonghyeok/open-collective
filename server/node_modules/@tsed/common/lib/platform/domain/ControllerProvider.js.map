{"version":3,"file":"ControllerProvider.js","sourceRoot":"","sources":["../../../src/platform/domain/ControllerProvider.ts"],"names":[],"mappings":"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","sourcesContent":["import {Enumerable, NotEnumerable, Type} from \"@tsed/core\";\nimport {Provider, ProviderType} from \"@tsed/di\";\nimport {JsonEntityStore} from \"@tsed/schema\";\nimport {ControllerMiddlewares, EndpointMetadata} from \"../../mvc\";\nimport {ROUTER_OPTIONS} from \"../constants/routerOptions\";\nimport {PlatformRouterMethods} from \"../interfaces/PlatformRouterMethods\";\n\nexport interface IChildrenController extends Type<any> {\n  $parentCtrl?: ControllerProvider;\n}\n\nexport class ControllerProvider<T = any> extends Provider<T> {\n  @NotEnumerable()\n  readonly entity: JsonEntityStore;\n  @NotEnumerable()\n  private router: PlatformRouterMethods;\n  /**\n   * Controllers that depend to this controller.\n   * @type {Array}\n   * @private\n   */\n  @NotEnumerable()\n  private _children: IChildrenController[] = [];\n\n  constructor(provide: any) {\n    super(provide);\n    this.type = ProviderType.CONTROLLER;\n    this.entity = JsonEntityStore.from(provide);\n  }\n\n  get path() {\n    return this.entity.path;\n  }\n\n  @Enumerable()\n  set path(path: string) {\n    this.entity.path = path;\n  }\n\n  /**\n   *\n   * @returns {Endpoint[]}\n   */\n  get endpoints(): EndpointMetadata[] {\n    return EndpointMetadata.getEndpoints(this.provide);\n  }\n\n  /**\n   *\n   * @returns {Type<any>[]}\n   */\n  get children(): IChildrenController[] {\n    return this._children;\n  }\n\n  /**\n   *\n   * @param children\n   */\n  @Enumerable()\n  set children(children: IChildrenController[]) {\n    this._children = children;\n    this._children.forEach((d) => (d.$parentCtrl = this));\n  }\n\n  /**\n   *\n   */\n  get routerOptions(): any {\n    return this.store.get(ROUTER_OPTIONS) || ({} as any);\n  }\n\n  /**\n   *\n   * @param value\n   */\n  set routerOptions(value: any) {\n    this.store.set(ROUTER_OPTIONS, value);\n  }\n\n  /**\n   *\n   * @returns {ControllerProvider}\n   */\n  get parent() {\n    return this.provide.$parentCtrl;\n  }\n\n  /**\n   *\n   * @returns {any[]}\n   */\n  get middlewares(): ControllerMiddlewares {\n    return Object.assign(\n      {\n        use: [],\n        useAfter: [],\n        useBefore: []\n      },\n      this.store.get(\"middlewares\") || {}\n    );\n  }\n\n  /**\n   *\n   * @param middlewares\n   */\n  set middlewares(middlewares: ControllerMiddlewares) {\n    const mdlwrs = this.middlewares;\n    const concat = (key: string, a: any, b: any) => (a[key] = a[key].concat(b[key]));\n\n    Object.keys(middlewares).forEach((key: string) => {\n      concat(key, mdlwrs, middlewares);\n    });\n    this.store.set(\"middlewares\", mdlwrs);\n  }\n\n  /**\n   * Resolve final endpoint url.\n   */\n  public getEndpointUrl(routerPath?: string): string {\n    return (routerPath === this.path ? this.path : (routerPath || \"\") + this.path).replace(/\\/\\//gi, \"/\");\n  }\n\n  /**\n   *\n   */\n  public hasEndpointUrl() {\n    return !!this.path;\n  }\n\n  /**\n   *\n   * @returns {boolean}\n   */\n  public hasChildren(): boolean {\n    return !!this.children.length;\n  }\n\n  /**\n   *\n   * @returns {boolean}\n   */\n  public hasParent(): boolean {\n    return !!this.provide.$parentCtrl;\n  }\n\n  public getRouter<T extends PlatformRouterMethods = any>(): T {\n    return this.router as any;\n  }\n\n  public setRouter(router: PlatformRouterMethods) {\n    this.router = router;\n\n    return this;\n  }\n}\n"]}