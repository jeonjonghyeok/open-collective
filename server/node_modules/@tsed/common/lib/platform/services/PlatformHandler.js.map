{"version":3,"file":"PlatformHandler.js","sourceRoot":"","sources":["../../../src/platform/services/PlatformHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import {isBoolean, isFunction, isNumber, isStream, isString, Type} from \"@tsed/core\";\nimport {Injectable, InjectorService, ProviderScope} from \"@tsed/di\";\nimport {ConverterService, EndpointMetadata, HandlerMetadata, HandlerType, IPipe, ParamMetadata, ParamTypes} from \"../../mvc\";\nimport {PlatformResponseFilter} from \"../../platform-response-filter/services/PlatformResponseFilter\";\nimport {HandlerContext, HandlerContextStatus} from \"../domain/HandlerContext\";\nimport {PlatformContext} from \"../domain/PlatformContext\";\nimport {ParamValidationError} from \"../errors/ParamValidationError\";\nimport {PlatformRouteWithoutHandlers} from \"../interfaces/PlatformRouterMethods\";\nimport {createHandlerMetadata} from \"../utils/createHandlerMetadata\";\nimport {renderView} from \"../utils/renderView\";\nimport {setResponseHeaders} from \"../utils/setResponseHeaders\";\n\nexport interface OnRequestOptions {\n  $ctx: PlatformContext;\n  metadata: HandlerMetadata;\n  next?: any;\n  err?: any;\n\n  [key: string]: any;\n}\n\nfunction shouldBeSent(data: any) {\n  return Buffer.isBuffer(data) || isBoolean(data) || isNumber(data) || isString(data) || data === null;\n}\n\nfunction shouldBeSerialized(data: any) {\n  return !(isStream(data) || shouldBeSent(data) || data === undefined);\n}\n\n/**\n * Platform Handler abstraction layer. Wrap original class method to a pure platform handler (Express, Koa, etc...).\n * @platform\n */\n@Injectable({\n  scope: ProviderScope.SINGLETON\n})\nexport class PlatformHandler {\n  constructor(protected injector: InjectorService) {}\n\n  /**\n   * Create a native middleware based on the given metadata and return an instance of HandlerContext\n   * @param input\n   * @param options\n   */\n  createHandler(input: EndpointMetadata | HandlerMetadata | any, options: PlatformRouteWithoutHandlers = {}) {\n    const metadata: HandlerMetadata = this.createHandlerMetadata(input, options);\n\n    this.sortPipes(metadata);\n\n    return this.createRawHandler(metadata);\n  }\n\n  /**\n   * Create handler metadata\n   * @param obj\n   * @param routeOptions\n   */\n  public createHandlerMetadata(obj: any | EndpointMetadata, routeOptions: PlatformRouteWithoutHandlers = {}): HandlerMetadata {\n    return createHandlerMetadata(this.injector, obj, routeOptions);\n  }\n\n  /**\n   * Get argument from parameter medata or handler context.\n   * @param type\n   * @param h\n   */\n  protected getArg(type: ParamTypes | string, h: HandlerContext) {\n    const {\n      $ctx,\n      $ctx: {request, response}\n    } = h;\n\n    switch (type) {\n      case ParamTypes.NODE_RESPONSE:\n        return $ctx.getRes();\n\n      case ParamTypes.NODE_REQUEST:\n        return $ctx.getReq();\n\n      case ParamTypes.FILES:\n        return h.getRequest().files;\n\n      case ParamTypes.RESPONSE:\n        return h.getResponse();\n\n      case ParamTypes.REQUEST:\n        return h.getRequest();\n\n      case ParamTypes.PLATFORM_RESPONSE:\n        return response;\n\n      case ParamTypes.PLATFORM_REQUEST:\n        return request;\n\n      case ParamTypes.NEXT_FN:\n        return h.next;\n\n      case ParamTypes.ERR:\n        return h.err;\n\n      case ParamTypes.$CTX: // tsed ctx\n        return $ctx;\n\n      case ParamTypes.ENDPOINT_INFO:\n        return $ctx.endpoint;\n\n      case ParamTypes.RESPONSE_DATA:\n        return $ctx.data;\n\n      case ParamTypes.BODY:\n        return request.body;\n\n      case ParamTypes.QUERY:\n        return request.query;\n\n      case ParamTypes.PATH:\n        return request.params;\n\n      case ParamTypes.HEADER:\n        return request.headers;\n\n      case ParamTypes.COOKIES:\n        return request.cookies;\n\n      case ParamTypes.SESSION:\n        return request.session;\n\n      case ParamTypes.LOCALS:\n        return response.locals;\n\n      default:\n        return h.request;\n    }\n  }\n\n  protected async onCtxRequest(requestOptions: OnRequestOptions): Promise<any> {\n    const {metadata, $ctx} = requestOptions;\n\n    await metadata.handler($ctx);\n\n    return this.next(requestOptions);\n  }\n\n  /**\n   * Call handler when a request his handle\n   * @param requestOptions\n   */\n  protected async onRequest(requestOptions: OnRequestOptions): Promise<any> {\n    const {metadata, $ctx, err} = requestOptions;\n\n    try {\n      const h = new HandlerContext({\n        $ctx,\n        metadata,\n        args: [],\n        err\n      });\n\n      h.args = await this.getArgs(h);\n\n      await h.callHandler();\n\n      if (h.status === HandlerContextStatus.RESOLVED) {\n        // Can be canceled by the handler itself\n        return await this.onSuccess($ctx.data, requestOptions);\n      }\n    } catch (er) {\n      return this.onError(er, requestOptions);\n    }\n  }\n\n  protected async onError(er: unknown, requestOptions: OnRequestOptions) {\n    const {next, $ctx} = requestOptions;\n    $ctx.data = er;\n\n    if (!next) {\n      throw er;\n    }\n\n    return !$ctx.response.isHeadersSent() && next && next(er);\n  }\n\n  /**\n   * Manage success scenario\n   * @param data\n   * @param requestOptions\n   * @protected\n   */\n  protected async onSuccess(data: any, requestOptions: OnRequestOptions) {\n    const {metadata, $ctx, next} = requestOptions;\n\n    if ($ctx.request.isAborted() || $ctx.response.isDone()) {\n      return;\n    }\n\n    // set headers each times that an endpoint is called\n    if (metadata.type === HandlerType.ENDPOINT) {\n      this.setHeaders($ctx);\n    }\n\n    // call returned middleware\n    if (isFunction(data) && !isStream(data)) {\n      return this.callReturnedMiddleware(data, $ctx, next);\n    }\n\n    if (metadata.isFinal()) {\n      return this.flush(data, $ctx);\n    }\n\n    return this.next(requestOptions);\n  }\n\n  /**\n   * Call the returned middleware by the handler.\n   * @param middleware\n   * @param ctx\n   * @param next\n   * @protected\n   */\n  protected callReturnedMiddleware(middleware: any, ctx: PlatformContext, next: any) {\n    return middleware(ctx.getRequest(), ctx.getResponse(), next);\n  }\n\n  /**\n   * Send the response to the consumer.\n   * @param data\n   * @param ctx\n   * @protected\n   */\n  protected async flush(data: any, ctx: PlatformContext) {\n    const {response, endpoint} = ctx;\n\n    if (endpoint.view) {\n      data = await this.render(data, ctx);\n    } else if (shouldBeSerialized(data)) {\n      data = this.injector.get<ConverterService>(ConverterService)!.serialize(data, {type: endpoint.responseType});\n    }\n\n    if (!response.isDone()) {\n      const responseFilter = this.injector.get<PlatformResponseFilter>(PlatformResponseFilter)!;\n\n      response.body(responseFilter.transform(data, ctx));\n    }\n  }\n\n  /**\n   * Render the view if the endpoint has a configured view.\n   * @param data\n   * @param ctx\n   * @protected\n   */\n  protected async render(data: any, ctx: PlatformContext) {\n    return renderView(data, ctx);\n  }\n\n  /**\n   * create Raw handler\n   * @param metadata\n   */\n  protected createRawHandler(metadata: HandlerMetadata): Function {\n    switch (metadata.type) {\n      case HandlerType.CUSTOM:\n        return (ctx: PlatformContext) => this.onRequest({metadata, $ctx: ctx});\n      case HandlerType.RAW_ERR_FN:\n      case HandlerType.RAW_FN:\n        return metadata.handler;\n\n      default:\n      case HandlerType.ENDPOINT:\n      case HandlerType.MIDDLEWARE:\n        return (request: any, response: any, next: any) => this.onRequest({$ctx: request.$ctx, next, metadata});\n    }\n  }\n\n  /**\n   * Set response headers\n   * @param ctx\n   * @protected\n   */\n  protected setHeaders(ctx: PlatformContext) {\n    return setResponseHeaders(ctx);\n  }\n\n  protected next(requestOptions: OnRequestOptions) {\n    const {$ctx, next} = requestOptions;\n\n    return !$ctx.response.isDone() && next && next();\n  }\n\n  /**\n   * Return arguments to call handler\n   * @param h\n   */\n  private async getArgs(h: HandlerContext) {\n    const {\n      metadata: {parameters}\n    } = h;\n\n    return Promise.all(parameters.map((param) => this.mapArg(param, h)));\n  }\n\n  /**\n   * Sort pipes before calling it\n   * @param metadata\n   */\n  private sortPipes(metadata: HandlerMetadata) {\n    if (!metadata.injectable) {\n      return;\n    }\n\n    const get = (pipe: Type<any>) => {\n      return this.injector.getProvider(pipe)!.priority || 0;\n    };\n\n    metadata.parameters.forEach((param: ParamMetadata) => {\n      return (param.pipes = param.pipes.sort((p1: Type<any>, p2: Type<any>) => {\n        return get(p1) < get(p2) ? -1 : get(p1) > get(p2) ? 1 : 0;\n      }));\n    });\n  }\n\n  /**\n   * Map argument by calling pipe.\n   * @param metadata\n   * @param h\n   */\n  private async mapArg(metadata: ParamMetadata, h: HandlerContext) {\n    const {injector} = h;\n    const value = this.getArg(metadata.paramType, h);\n\n    // istanbul ignore next\n    const handleError = async (cb: Function) => {\n      try {\n        return await cb();\n      } catch (er) {\n        throw ParamValidationError.from(metadata, er);\n      }\n    };\n\n    return metadata.pipes.reduce(async (value, pipe) => {\n      value = await value;\n\n      return handleError(() => injector.get<IPipe>(pipe)!.transform(value, metadata));\n    }, value);\n  }\n}\n"]}