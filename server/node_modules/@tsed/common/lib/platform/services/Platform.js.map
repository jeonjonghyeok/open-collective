{"version":3,"file":"Platform.js","sourceRoot":"","sources":["../../../src/platform/services/Platform.ts"],"names":[],"mappings":"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","sourcesContent":["import {Injectable, InjectorService, ProviderScope, ProviderType, TokenProvider} from \"@tsed/di\";\nimport {EndpointMetadata, HandlerMetadata} from \"../../mvc\";\nimport {PlatformControllerBuilder} from \"../builder/PlatformControllerBuilder\";\nimport {ControllerProvider} from \"../domain/ControllerProvider\";\nimport {IRoute, IRouteController, IRouteDetails} from \"../interfaces/IRoute\";\nimport {PlatformApplication} from \"./PlatformApplication\";\nimport {PlatformHandler} from \"./PlatformHandler\";\nimport {PlatformRouter} from \"./PlatformRouter\";\n\n/**\n * `Platform` is used to provide all routes collected by annotation `@Controller`.\n *\n * @platform\n */\n@Injectable({\n  scope: ProviderScope.SINGLETON\n})\nexport class Platform {\n  private _routes: IRouteController[] = [];\n\n  constructor(\n    readonly injector: InjectorService,\n    readonly platformApplication: PlatformApplication,\n    readonly platformHandler: PlatformHandler\n  ) {}\n\n  get app() {\n    return this.platformApplication;\n  }\n\n  get routes(): IRouteController[] {\n    return this._routes || [];\n  }\n\n  /**\n   * Create a native handler function based on the given handlerMetadata.\n   * @param handler\n   */\n  public createHandler(handler: HandlerMetadata | any) {\n    return this.platformHandler.createHandler(handler);\n  }\n\n  /**\n   * Create routers from the collected controllers\n   */\n  public createRoutersFromControllers() {\n    const {injector} = this;\n\n    return injector\n      .getProviders(ProviderType.CONTROLLER)\n      .map((provider) => {\n        if (!provider.hasParent()) {\n          return new PlatformControllerBuilder(provider as ControllerProvider).build(injector);\n        }\n      })\n      .filter(Boolean);\n  }\n\n  /**\n   * Create a new instance of PlatformRouter\n   * @param routerOptions\n   */\n  public createRouter(routerOptions: any = {}): PlatformRouter {\n    return PlatformRouter.create(this.injector, routerOptions);\n  }\n\n  public addRoutes(routes: IRoute[]) {\n    routes.forEach((routeSettings) => {\n      this.addRoute(routeSettings.route, routeSettings.token);\n    });\n  }\n\n  public addRoute(endpoint: string, token: TokenProvider) {\n    const {injector} = this;\n\n    if (injector.hasProvider(token)) {\n      const provider: ControllerProvider = injector.getProvider(token)! as any;\n\n      if (provider.type === ProviderType.CONTROLLER) {\n        const route = provider.getEndpointUrl(endpoint);\n\n        if (!provider.hasParent()) {\n          this._routes.push({\n            route,\n            provider\n          });\n          this.app.use(route, ...[].concat(provider.getRouter().callback()));\n        }\n      }\n    }\n\n    return this;\n  }\n\n  /**\n   * Get all routes built by TsExpressDecorators and mounted on Express application.\n   * @returns {IRouteDetails[]}\n   */\n  public getRoutes(): IRouteDetails[] {\n    let routes: IRouteDetails[] = [];\n\n    this.routes.forEach((config: {route: string; provider: ControllerProvider}) => {\n      routes = routes.concat(this.buildRoutes(config.route, config.provider));\n    });\n\n    return routes;\n  }\n\n  /**\n   *\n   * @param ctrl\n   * @param endpointUrl\n   */\n  private buildRoutes(endpointUrl: string, ctrl: ControllerProvider): IRouteDetails[] {\n    const {injector} = this;\n\n    let routes: IRouteDetails[] = [];\n\n    ctrl.children\n      .map((ctrl) => injector.getProvider(ctrl))\n      .forEach((provider: ControllerProvider) => {\n        routes = routes.concat(this.buildRoutes(`${endpointUrl}${provider.path}`, provider));\n      });\n\n    ctrl.endpoints.forEach((endpoint: EndpointMetadata) => {\n      const {operationPaths, params, targetName, propertyKey} = endpoint;\n\n      operationPaths.forEach(({path, method}) => {\n        if (method) {\n          routes.push({\n            method,\n            name: `${targetName}.${String(propertyKey)}()`,\n            url: `${endpointUrl}${path || \"\"}`.replace(/\\/\\//gi, \"/\"),\n            className: targetName,\n            methodClassName: String(propertyKey),\n            parameters: params\n          });\n        }\n      });\n    });\n\n    return routes;\n  }\n}\n"]}