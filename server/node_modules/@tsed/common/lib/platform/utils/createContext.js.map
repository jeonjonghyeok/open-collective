{"version":3,"file":"createContext.js","sourceRoot":"","sources":["../../../src/platform/utils/createContext.ts"],"names":[],"mappings":";;;AACA,+DAA0D;AAC1D,iEAA4D;AAC5D,mEAA8D;AAE9D,MAAM,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC;AAClC,MAAM,mBAAmB,GAAG,GAAG,EAAE,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;AAE9D;;;;;;GAMG;AACI,KAAK,UAAU,aAAa,CAAC,QAAyB,EAAE,GAAQ,EAAE,GAAQ;IAC/E,MAAM,EAAC,KAAK,EAAE,iBAAiB,EAAE,YAAY,EAAE,YAAY,GAAG,mBAAmB,EAAC,GAAG,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC;IAE9G,MAAM,EAAE,GAAG,YAAY,EAAE,CAAC;IAC1B,MAAM,OAAO,GAAG,iCAAe,CAAC,MAAM,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;IACtD,MAAM,QAAQ,GAAG,mCAAgB,CAAC,MAAM,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;IAExD,MAAM,GAAG,GAAG,IAAI,iCAAe,CAAC;QAC9B,EAAE;QACF,MAAM,EAAE,QAAQ,CAAC,MAAM;QACvB,GAAG,EAAE,OAAO,CAAC,GAAG;QAChB,iBAAiB;QACjB,KAAK;QACL,YAAY;QACZ,QAAQ;QACR,QAAQ;QACR,OAAO;KACR,CAAC,CAAC;IAEH,GAAG,CAAC,IAAI,GAAG,GAAG,CAAC;IAEf,QAAQ,CAAC,KAAK,CAAC,KAAK,IAAI,EAAE;QACxB,MAAM,GAAG,CAAC,IAAI,CAAC,aAAa,EAAE,GAAG,CAAC,CAAC;QACnC,MAAM,GAAG,CAAC,OAAO,EAAE,CAAC;QACpB,OAAO,GAAG,CAAC,IAAI,CAAC;IAClB,CAAC,CAAC,CAAC;IAEH,MAAM,GAAG,CAAC,IAAI,CAAC,YAAY,EAAE,GAAG,CAAC,CAAC;IAElC,OAAO,GAAG,CAAC;AACb,CAAC;AA9BD,sCA8BC","sourcesContent":["import {InjectorService} from \"@tsed/di\";\nimport {PlatformContext} from \"../domain/PlatformContext\";\nimport {PlatformRequest} from \"../services/PlatformRequest\";\nimport {PlatformResponse} from \"../services/PlatformResponse\";\n\nconst uuidv4 = require(\"uuid\").v4;\nconst defaultReqIdBuilder = () => uuidv4().replace(/-/gi, \"\");\n\n/**\n * Create the TsED context to wrap request, response, injector, etc...\n * @param injector\n * @param req\n * @param res\n * @ignore\n */\nexport async function createContext(injector: InjectorService, req: any, res: any): Promise<PlatformContext> {\n  const {level, ignoreUrlPatterns, maxStackSize, reqIdBuilder = defaultReqIdBuilder} = injector.settings.logger;\n\n  const id = reqIdBuilder();\n  const request = PlatformRequest.create(injector, req);\n  const response = PlatformResponse.create(injector, res);\n\n  const ctx = new PlatformContext({\n    id,\n    logger: injector.logger,\n    url: request.url,\n    ignoreUrlPatterns,\n    level,\n    maxStackSize,\n    injector,\n    response,\n    request\n  });\n\n  req.$ctx = ctx;\n\n  response.onEnd(async () => {\n    await ctx.emit(\"$onResponse\", ctx);\n    await ctx.destroy();\n    delete req.$ctx;\n  });\n\n  await ctx.emit(\"$onRequest\", ctx);\n\n  return ctx;\n}\n"]}