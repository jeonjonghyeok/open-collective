{"version":3,"file":"ErrorFilter.js","sourceRoot":"","sources":["../../../src/platform-exceptions/components/ErrorFilter.ts"],"names":[],"mappings":";;;;AAAA,qCAAgD;AAIhD,+CAA0C;AAI1C,IAAa,WAAW,GAAxB,MAAa,WAAW;IACtB,KAAK,CAAC,KAAU,EAAE,GAAoB;QACpC,MAAM,EAAC,QAAQ,EAAE,MAAM,EAAE,GAAG,EAAC,GAAG,GAAG,CAAC;QACpC,MAAM,GAAG,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;QAEtC,MAAM,CAAC,KAAK,CAAC;YACX,KAAK,EAAE,EAAC,GAAG,GAAG,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAC;SACpC,CAAC,CAAC;QAEH,QAAQ;aACL,KAAK,CAAC,GAAG,EAAE;YACV,GAAG,KAAK,aAAa,IAAI,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAC5D,CAAC,CAAC;aACD,UAAU,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;aAClC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC;aAClB,WAAW,CAAC,kBAAkB,CAAC;aAC/B,IAAI,CAAC,GAAG,KAAK,UAAG,CAAC,IAAI,CAAC,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;IAC1D,CAAC;IAED,QAAQ,CAAC,KAAU,EAAE,GAAS;;QAC5B,OAAO;YACL,IAAI,EAAE,OAAA,KAAK,CAAC,MAAM,0CAAE,IAAI,KAAI,KAAK,CAAC,IAAI;YACtC,OAAO,EAAE,KAAK,CAAC,OAAO;YACtB,MAAM,EAAE,KAAK,CAAC,MAAM,IAAI,GAAG;YAC3B,MAAM,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC;YAC7B,KAAK,EAAE,GAAG,KAAK,UAAG,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS;SACjD,CAAC;IACJ,CAAC;IAES,SAAS,CAAC,KAAU;QAC5B,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,EAAC,MAAM,EAAsB,EAAE,EAAE;YAC1F,OAAO,CAAC,GAAG,IAAI,EAAE,GAAG,CAAC,MAAM,IAAI,EAAE,CAAC,CAAC,CAAC;QACtC,CAAC,EAAE,EAAE,CAAC,CAAC;IACT,CAAC;IAES,UAAU,CAAC,KAAU;QAC7B,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,EAAC,OAAO,EAAsB,EAAE,EAAE;YAC1F,OAAO;gBACL,GAAG,GAAG;gBACN,GAAG,CAAC,OAAO,IAAI,EAAE,CAAC;aACnB,CAAC;QACJ,CAAC,EAAE,EAAE,CAAC,CAAC;IACT,CAAC;CACF,CAAA;AA3CY,WAAW;IADvB,aAAK,CAAC,KAAK,CAAC;GACA,WAAW,CA2CvB;AA3CY,kCAAW","sourcesContent":["import {classOf, Env, nameOf} from \"@tsed/core\";\nimport {BadRequest} from \"@tsed/exceptions\";\nimport type {ResponseErrorObject} from \"../../mvc/interfaces/ResponseErrorObject\";\nimport type {PlatformContext} from \"../../platform/domain/PlatformContext\";\nimport {Catch} from \"../decorators/catch\";\nimport type {ExceptionFilterMethods} from \"../interfaces/ExceptionFilterMethods\";\n\n@Catch(Error)\nexport class ErrorFilter implements ExceptionFilterMethods {\n  catch(error: any, ctx: PlatformContext): void {\n    const {response, logger, env} = ctx;\n    const err = this.mapError(error, env);\n\n    logger.error({\n      error: {...err, stack: error.stack}\n    });\n\n    response\n      .onEnd(() => {\n        env === \"development\" && ctx.injector.logger.error(error);\n      })\n      .setHeaders(this.getHeaders(error))\n      .status(err.status)\n      .contentType(\"application/json\")\n      .body(env === Env.PROD ? \"InternalServerError\" : err);\n  }\n\n  mapError(error: any, env?: Env) {\n    return {\n      name: error.origin?.name || error.name,\n      message: error.message,\n      status: error.status || 500,\n      errors: this.getErrors(error),\n      stack: env === Env.DEV ? error.stack : undefined\n    };\n  }\n\n  protected getErrors(error: any) {\n    return [error, error.origin].filter(Boolean).reduce((errs, {errors}: ResponseErrorObject) => {\n      return [...errs, ...(errors || [])];\n    }, []);\n  }\n\n  protected getHeaders(error: any) {\n    return [error, error.origin].filter(Boolean).reduce((obj, {headers}: ResponseErrorObject) => {\n      return {\n        ...obj,\n        ...(headers || {})\n      };\n    }, {});\n  }\n}\n"]}