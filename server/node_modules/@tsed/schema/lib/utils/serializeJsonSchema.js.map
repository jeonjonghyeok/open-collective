{"version":3,"file":"serializeJsonSchema.js","sourceRoot":"","sources":["../../src/utils/serializeJsonSchema.ts"],"names":[],"mappings":"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","sourcesContent":["import {classOf, deepExtends, isArray, isObject} from \"@tsed/core\";\nimport {mapAliasedProperties} from \"../domain/JsonAliasMap\";\nimport {JsonSchema} from \"../domain/JsonSchema\";\nimport {SpecTypes} from \"../domain/SpecTypes\";\nimport {alterIgnore} from \"../hooks/ignoreHook\";\nimport {JsonSchemaOptions} from \"../interfaces\";\nimport {GenericsContext, mapGenericsOptions, popGenerics} from \"./generics\";\nimport {getInheritedStores} from \"./getInheritedStores\";\nimport {getJsonEntityStore} from \"./getJsonEntityStore\";\nimport {getRequiredProperties} from \"./getRequiredProperties\";\n\n/**\n * @ignore\n */\nconst IGNORES = [\"name\", \"$required\", \"$hooks\", \"_nestedGenerics\"];\n/**\n * @ignore\n */\nconst IGNORES_OPENSPEC = [\"const\"];\n\n/**\n * @ignore\n */\nfunction isEmptyProperties(key: string, value: any) {\n  return typeof value === \"object\" && [\"items\", \"properties\", \"additionalProperties\"].includes(key) && Object.keys(value).length === 0;\n}\n\n/**\n * @ignore\n */\nfunction shouldMapAlias(key: string, value: any, useAlias: boolean) {\n  return typeof value === \"object\" && useAlias && [\"properties\", \"additionalProperties\"].includes(key);\n}\n\n/**\n * @ignore\n */\nfunction createRef(name: string, options: JsonSchemaOptions) {\n  const host = getHost(options);\n  return {\n    $ref: `${host}/${name}`\n  };\n}\n\n/**\n * @ignore\n */\nexport function serializeClass(value: any, options: JsonSchemaOptions = {}) {\n  const store = getJsonEntityStore(value.class);\n  const name = store.schema.getName() || value.getName();\n\n  if (value.hasGenerics) {\n    // Inline generic\n    const {type, properties, additionalProperties, items, ...props} = value.toJSON(options);\n    const schema = {\n      ...serializeAny(store.schema, {\n        ...options,\n        ...popGenerics(value),\n        root: false\n      }),\n      ...props\n    };\n\n    if (schema.title) {\n      const {title} = schema;\n      options.schemas![title] = schema;\n      delete schema.title;\n\n      return createRef(title, options);\n    }\n\n    return schema;\n  }\n\n  if (options.schemas && !options.schemas[name]) {\n    options.schemas[name] = {}; // avoid infinite calls\n    options.schemas[name] = serializeAny(\n      store.schema,\n      mapGenericsOptions({\n        ...options,\n        root: false\n      })\n    );\n  }\n\n  return createRef(name, options);\n}\n\n/**\n * ignore\n * @param options\n */\nfunction getHost(options: JsonSchemaOptions) {\n  const {host = `#/${options.specType === \"openapi3\" ? \"components/schemas\" : \"definitions\"}`} = options;\n\n  return host;\n}\n\nfunction toRef(value: any, schema: any, options: JsonSchemaOptions) {\n  const name = value.getName();\n  options.schemas![value.getName()] = schema;\n\n  return createRef(name, options);\n}\n\n/**\n * @ignore\n */\nexport function serializeItem(value: any, options: JsonSchemaOptions) {\n  return value && value.isClass ? serializeClass(value, options) : serializeAny(value, options);\n}\n\n/**\n * @ignore\n */\nexport function serializeInherited(obj: any, target: any, options: JsonSchemaOptions = {}) {\n  const stores = Array.from(getInheritedStores(target).entries()).filter(([model]) => classOf(model) !== classOf(target));\n\n  if (stores.length) {\n    const schema = stores.reduce((obj, [, store]) => {\n      return deepExtends(obj, serializeJsonSchema(store.schema, options));\n    }, {});\n\n    obj = deepExtends(schema, obj);\n  }\n\n  return obj;\n}\n\n/**\n * Serialize class which inherit from Map like JsonMap, JsonOperation, JsonParameter.\n * @param input\n * @param options\n * @ignore\n */\nexport function serializeMap(input: Map<string, any>, options: JsonSchemaOptions = {}): any {\n  options = mapGenericsOptions(options);\n\n  return Array.from(input.entries()).reduce((obj: any, [key, value]) => {\n    obj[key] = serializeItem(value, options);\n    return obj;\n  }, {});\n}\n\n/**\n * Serialize Any object to a json schema\n * @param input\n * @param options\n * @ignore\n */\nexport function serializeObject(input: any, options: JsonSchemaOptions) {\n  return Object.entries(input).reduce<any>(\n    (obj, [key, value]: any[]) => {\n      if (!alterIgnore(value, options)) {\n        obj[key] = serializeItem(value, options);\n      }\n\n      return obj;\n    },\n    isArray(input) ? [] : {}\n  );\n}\n\n/**\n * @ignore\n */\nexport function serializeAny(input: any, options: JsonSchemaOptions = {}) {\n  options.schemas = options.schemas || {};\n\n  if (typeof input !== \"object\" || input === null) {\n    return input;\n  }\n\n  if (\"toJSON\" in input) {\n    const schema = input.toJSON(mapGenericsOptions(options));\n\n    return input.canRef ? toRef(input, schema, options) : schema;\n  }\n\n  return serializeObject(input, options);\n}\n\n/**\n * @ignore\n */\nexport function serializeGenerics(obj: any, options: GenericsContext) {\n  const {generics} = options;\n\n  if (generics && obj.$ref) {\n    if (generics.has(obj.$ref)) {\n      const model = {\n        class: generics.get(obj.$ref)\n      };\n\n      if (options.nestedGenerics.length === 0) {\n        return serializeClass(model, {\n          ...options,\n          generics: undefined\n        });\n      }\n\n      const store = getJsonEntityStore(model.class);\n\n      return serializeJsonSchema(store.schema, {\n        ...options,\n        ...popGenerics(options),\n        root: false\n      });\n    }\n  }\n\n  return obj;\n}\n\nfunction shouldSkipKey(key: string, {specType = SpecTypes.JSON}: JsonSchemaOptions) {\n  return IGNORES.includes(key) || (specType !== SpecTypes.JSON && IGNORES_OPENSPEC.includes(key));\n}\n\n/**\n * Convert JsonSchema instance to plain json object\n * @param schema\n * @param options\n * @ignore\n */\nexport function serializeJsonSchema(schema: JsonSchema, options: JsonSchemaOptions = {}): any {\n  const {useAlias = true, schemas = {}, genericTypes} = options;\n\n  let obj: any = [...schema.entries()].reduce((item: any, [key, value]) => {\n    if (shouldSkipKey(key, options)) {\n      return item;\n    }\n\n    if (key === \"type\") {\n      value = schema.getJsonType();\n    }\n\n    if (key === \"examples\" && isObject(value) && [SpecTypes.OPENAPI, SpecTypes.SWAGGER].includes(options.specType!)) {\n      key = \"example\";\n      value = Object.values(value)[0];\n    }\n\n    if (value) {\n      if (value.isClass) {\n        value = serializeClass(value, {\n          ...options,\n          useAlias,\n          schemas\n        });\n      } else {\n        value = serializeAny(value, {\n          ...options,\n          useAlias,\n          schemas,\n          genericTypes,\n          genericLabels: schema.genericLabels\n        });\n      }\n    }\n\n    if (isEmptyProperties(key, value)) {\n      return item;\n    }\n\n    if (shouldMapAlias(key, value, useAlias)) {\n      value = mapAliasedProperties(value, schema.alias);\n    }\n\n    item[key] = value;\n\n    return item;\n  }, {});\n\n  if (schema.isClass) {\n    obj = serializeInherited(obj, schema.getComputedType(), {...options, root: false, schemas});\n  }\n\n  obj = serializeGenerics(obj, {...options, root: false, schemas} as any);\n  obj = getRequiredProperties(obj, schema, useAlias);\n\n  return obj;\n}\n"]}